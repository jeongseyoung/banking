<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- private long accountId;
    private long counterpartyAccountId;
    private TransferType transferType;
    private long amount;
    private long balanceAfter;
    private String memo;
    private LocalDateTime t; -->
<mapper namespace="com.sy.banking.transfer.mapper.TransferMapper">
  <!-- void saveTransaction(TransactionReq transactionReq); -->
  <insert id="saveTransaction" parameterType="com.sy.banking.domain.item.req.TransactionReq">
    INSERT INTO transactions (account_id, type, counterparty_account_id, amount, balance_after, memo, created_at)
    VALUES (#{accountId},
            #{transferType}, 
            #{counterpartyAccountId}, 
            #{amount}, 
            #{balanceAfter}, 
            #{memo}, 
            #{t})
  </insert>
    
  <!-- //total count
    int countByAccountId(long accountId); -->
  <select id="countByAccountId" resultType="long">
    SELECT COUNT(*) FROM transactions WHERE account_id = #{accountId}
  </select>

  <!-- List<TransactionListItem> findListByAccountId(ASPageItem asPageItem) -->
  <select id="findListByAccountId" parameterType="map" resultType="TransactionListItem">
    SELECT account_id, type, counterparty_account_id, amount, balance_after, memo, created_at
    FROM transactions
    <where>
      account_id = #{accountId}
      <if test="page.transferType != null">
        AND type = #{page.transferType}
      </if>
    </where>
    ORDER BY created_at 
    <choose>
      <when test="page.orderByType == 'ASC'">
        ASC
      </when>
      <otherwise>
        DESC
      </otherwise>
    </choose>
    LIMIT #{page.size}
    OFFSET #{page.offset}
    FOR UPDATE
  </select> 

  <!-- //트랜잭션 리스트 - 엑셀다운용 - 페이징 X
    List<TransactionListItem> findListByAccountId_NoPaging(long userId) -->
   <select id="findListByAccountId_NoPaging" parameterType="map" resultType="TransactionListItem">
    SELECT * FROM  transactions WHERE account_id = #{accountId}
   </select>
</mapper>